<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UH: Campus Recycling Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha2d1-sFwU1XfXQkH7Q7w708j41lW1201HlJ4j649E6N6z5lJ7/7U7Y5e3N5p7p7q7r" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha2d1-3j808CgL1U11V6l5p5W14v3S2r0D5n4B8j5S2V2P5p5p5V4T5S5U4H6U7G9F" crossorigin=""></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* Custom styles for the app */
        .sidebar {
            transition: all 0.3s ease-in-out;
        }
        .content-area {
            transition: margin-left 0.3s ease-in-out;
        }
        /* Ensure the map container has a fixed height for Leaflet */
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
    
    <script>
        // Set Tailwind configuration to use the Inter font and UH-inspired colors
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-red': '#CC0033', /* Cougar Red */
                        'primary-dark': '#990000', /* Deep Red for sidebar/accents */
                        'secondary-contrast': '#1A1A1A', /* Black/Dark Gray for contrast */
                        'secondary-gray': '#F3F4F6',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-secondary-gray min-h-screen flex font-sans">

    <!-- Firestore Mandatory Global Variables -->
    <script type="module">
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        console.log(`App ID: ${appId}`);
    
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            setLogLevel('Debug');
            
            if (initialAuthToken) {
                signInWithCustomToken(window.auth, initialAuthToken)
                    .then(() => console.log("Signed in with custom token."))
                    .catch(error => console.error("Error signing in with custom token:", error));
            } else {
                signInAnonymously(window.auth)
                    .then(() => console.log("Signed in anonymously."))
                    .catch(error => console.error("Error signing in anonymously:", error));
            }
        } catch (e) {
            console.error("Firebase initialization skipped:", e);
        }
    </script>

    <!-- Sidebar / Navigation -->
    <nav class="sidebar w-64 bg-primary-dark text-white p-4 flex flex-col shadow-2xl">
        <h1 class="text-3xl font-bold mb-8 p-2 border-b border-primary-red">UH Recycling Tracker</h1>
        <div class="flex flex-col space-y-2">
            <a href="#" id="nav-map-data" data-target="map-data-content" 
               class="nav-link p-4 block text-lg font-semibold rounded-lg bg-primary-red">üìç Live Map & Data</a>
            
            <!-- Campus Cleanup Challenge is the only other view -->
            <a href="#" id="nav-challenge" data-target="cleanup-challenge-content" 
               class="nav-link p-4 block text-lg font-semibold rounded-lg hover:bg-primary-red">üèÜ University Challenge</a>
        </div>
        <div class="mt-auto p-4 text-sm text-gray-200">
            <p>User ID: <span id="user-id">Loading...</span></p>
            <p>&copy; 2025 UH Sustainability</p>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="content-area flex-1 p-6 md:p-10">
        <h2 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-6 border-b pb-2">UH Recycling Dashboard</h2>

        <!-- Map and Data Content (Default View) -->
        <section id="map-data-content" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2 bg-white shadow-xl rounded-xl p-4">
                    <h3 class="text-2xl font-bold text-gray-700 mb-3">Recycling Bin Locations (35 Bins)</h3>
                    <div id="map" class="rounded-lg shadow-inner"></div>
                </div>
                <div class="lg:col-span-1 bg-white shadow-xl rounded-xl p-4">
                    <h3 class="text-2xl font-bold text-gray-700 mb-3">Weekly Metrics</h3>
                    <div class="h-64">
                        <canvas id="recyclingChart"></canvas>
                    </div>
                    <div class="mt-4 space-y-3">
                        <p class="text-lg flex justify-between">Total Weight Recycled (KG): <span class="font-bold text-primary-red" id="total-weight">...</span></p>
                        <p class="text-lg flex justify-between">Total XP Earned: <span class="font-bold text-secondary-contrast" id="total-xp">...</span></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Campus Cleanup Challenge Content -->
        <section id="cleanup-challenge-content" class="content-section hidden">
            <div class="bg-white shadow-xl rounded-xl p-6">
                <h3 class="text-3xl font-bold text-primary-red mb-4 flex items-center">
                    <span class="mr-2">üèÜ Inter-University Recycling Challenge</span>
                </h3>
                
                <p class="text-lg text-gray-600 mb-6">See how the University of Houston's **total recycling effort** stacks up against other major universities this week!</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Countdown Timer Card -->
                    <div class="bg-primary-dark text-white p-6 rounded-xl shadow-lg transform hover:scale-[1.01] transition duration-300">
                        <h4 class="text-xl font-semibold mb-2">Next Reset In:</h4>
                        <div id="challenge-timer" class="text-5xl font-extrabold tracking-tight">Loading...</div>
                    </div>

                    <!-- UH Total Score Card -->
                    <div class="bg-primary-red text-white p-6 rounded-xl shadow-lg transform hover:scale-[1.01] transition duration-300">
                        <h4 class="text-xl font-semibold mb-2">UH Current Weekly Score:</h4>
                        <div id="uh-total-score-display" class="text-5xl font-extrabold tracking-tight">Calculating...</div>
                    </div>
                </div>
                
                <!-- Leaderboard -->
                <div class="mt-8">
                    <h4 class="text-3xl font-bold text-gray-700 mb-4">Top 5 University Leaderboard</h4>
                    <ol id="leaderboard-list" class="space-y-4">
                        <!-- Leaderboard items will be injected here -->
                    </ol>
                </div>
            </div>
        </section>

    </main>

    <script>
        // --- 1. HARDCODED DATA DEFINITION (35 Bins for University of Houston) ---

        const campusCenter = [29.7208, -95.3425]; // Center for UH main campus

        // Function to generate a random number within a range (min, max)
        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        // Function to generate a random coordinate near the center
        const randCoord = (center, range) => (center + (Math.random() - 0.5) * 2 * range).toFixed(4);

        const BIN_DATA = [];

        // Pre-defined names for a more realistic feel (35 names total)
        const buildingNames = [
            'Cemo Hall', 'M.D. Anderson Library', 'Moody Towers', 'University Center', 
            'Cullen Performance Hall', 'Student Center South', 'Science and Engineering Classroom', 
            'Agnes Arnold Hall', 'Roy G. Cullen Building', 'Campus Recreation Center', 
            'E. Cullen Building', 'Athletics/Alumni Center', 'Law Center', 
            'Health and Biomedical Sciences', 'Garrison Hall', 'Fine Arts Building', 
            'College of Technology', 'Cougar Village', 'ERP Hall', 
            'Melcher Hall', 'P G C F & Research', 'Fleming Hall', 'Welcome Center',
            'McElhinney Hall', 'SERC Building', 'Parking Garage 1', 'University Lofts',
            'College of Optometry', 'Energy Research Park', 'Wortham Theater',
            'TDECU Stadium - North', 'TDECU Stadium - South', 'Technology Building', 
            'Farish Hall', 'Student Center North'
        ];

        for (let i = 0; i < 35; i++) {
            const totalWeight = rand(500, 2000);
            BIN_DATA.push({
                id: `bin_${String.fromCharCode(65 + i)}`,
                name: `${buildingNames[i] || 'Building Area'} Bin ${i + 1}`,
                lat: parseFloat(randCoord(campusCenter[0], 0.005)), // +/- 0.005 degrees latitude
                lon: parseFloat(randCoord(campusCenter[1], 0.005)), // +/- 0.005 degrees longitude
                total_weight_kg: totalWeight,
                total_xp: totalWeight * 4, // Simple XP calculation
                weekly_score: rand(500, 1300), // Individual bin score
            });
        }
        
        // Mock data for other universities
        const UNIVERSITY_LEADERBOARD = [
            { name: 'University of Texas at Austin', score: 55200 },
            { name: 'Texas A&M University', score: 48000 },
            { name: 'Texas Tech University', score: 45000 },
            { name: 'Rice University', score: 32000 },
            { name: 'Baylor University', score: 38900 },
            { name: 'UT San Antonio', score: 29500 },
            { name: 'Texas State University', score: 34500 },
        ];


        // --- 2. GLOBAL STATE & UTILITIES ---
        let challengeEndDate;
        const XP_REWARDS = { 1: 1000, 2: 750, 3: 500 }; // Higher XP for inter-university competition
        
        // Calculates the sum of all UH bin weekly scores
        const calculateUHTotalScore = () => BIN_DATA.reduce((sum, bin) => sum + bin.weekly_score, 0);


        // Function to set the challenge end date (Next Sunday at 11:59:59 PM)
        function calculateChallengeEndDate() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const daysUntilSunday = (7 - dayOfWeek) % 7;
            
            const nextSunday = new Date(now);
            nextSunday.setDate(now.getDate() + daysUntilSunday);
            
            // Set time to 23:59:59 (11:59:59 PM)
            nextSunday.setHours(23, 59, 59, 999);
            
            // If it's already Sunday past midnight, set it for the NEXT Sunday
            if (dayOfWeek === 0 && now.getHours() > 0) {
                 nextSunday.setDate(nextSunday.getDate() + 7);
            }

            return nextSunday;
        }

        // --- 3. UI VIEW MANAGEMENT (Simplified) ---
        function switchView(targetId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(targetId).classList.remove('hidden');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-primary-red');
            });
            document.querySelector(`[data-target="${targetId}"]`).classList.add('bg-primary-red');

            // Initialize leaderboard for the challenge content
            if (targetId === 'cleanup-challenge-content') {
                generateLeaderboard();
            }
        }

        // --- 4. LEAFLET MAP & CHART.JS INIT ---
        function initMapAndCharts() {
            // Update summary statistics based on all 35 bins
            const totalWeight = BIN_DATA.reduce((sum, bin) => sum + bin.total_weight_kg, 0).toFixed(1);
            const totalXp = BIN_DATA.reduce((sum, bin) => sum + bin.total_xp, 0);
            document.getElementById('total-weight').textContent = `${totalWeight} KG`;
            document.getElementById('total-xp').textContent = `${totalXp} XP`;

            // Initialize Map
            const map = L.map('map').setView(campusCenter, 16); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Add markers for each bin with pop-up stats
            BIN_DATA.forEach(bin => {
                const marker = L.marker([bin.lat, bin.lon]).addTo(map);
                marker.bindPopup(`
                    <div class="font-sans">
                        <h4 class="font-bold text-lg text-primary-red">${bin.name}</h4>
                        <p>Total Recycled: <b>${bin.total_weight_kg} kg</b></p>
                        <p>Total XP Earned: <b>${bin.total_xp} XP</b></p>
                        <p class="text-xs text-gray-500 mt-1">Weekly Score: ${bin.weekly_score}</p>
                    </div>
                `); 
            });

            // Initialize Chart.js
            const chartDataSample = BIN_DATA.slice(0, 10); // Still show top 10 individual bins for internal metrics
            const ctx = document.getElementById('recyclingChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartDataSample.map(bin => bin.name.split(' ')[0]),
                    datasets: [{
                        label: 'Weekly Score (Top 10 Bins)',
                        data: chartDataSample.map(bin => bin.weekly_score),
                        backgroundColor: chartDataSample.map(bin => bin.weekly_score > 1000 ? '#CC0033' : '#1A1A1A'), 
                        borderColor: 'transparent',
                        borderWidth: 1,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Bin Weekly Contribution (Top 10)' }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Score' } }
                    }
                }
            });
        }

        // --- 5. GAMIFICATION: CHALLENGE LOGIC ---

        function updateTimer() {
            const now = new Date().getTime();
            const distance = challengeEndDate.getTime() - now;
            const timerElement = document.getElementById('challenge-timer');

            if (distance < 0) {
                // Challenge has reset
                timerElement.textContent = "CHALLENGE RESETTING...";
                console.log("Weekly Challenge Reset Triggered.");
                challengeEndDate = calculateChallengeEndDate();
                setTimeout(updateTimer, 1000); 
                generateLeaderboard();
                return;
            }

            // Calculate days, hours, minutes, and seconds
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Display the result
            timerElement.innerHTML = `<span class="text-3xl">${days}d</span> ${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m ${String(seconds).padStart(2, '0')}s`;
        }

        function generateLeaderboard() {
            const uhScore = calculateUHTotalScore();
            document.getElementById('uh-total-score-display').textContent = uhScore.toLocaleString();

            // Create a combined list including UH
            let combinedLeaderboard = [...UNIVERSITY_LEADERBOARD];
            combinedLeaderboard.push({ name: 'University of Houston', score: uhScore, isUH: true });

            // Sort by score descending
            combinedLeaderboard.sort((a, b) => b.score - a.score);

            // Get the top 5
            const top5 = combinedLeaderboard.slice(0, 5);
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = ''; 

            const medalColors = { 1: 'text-yellow-500', 2: 'text-gray-400', 3: 'text-yellow-700' };

            top5.forEach((uni, index) => {
                const rank = index + 1;
                
                const listItem = document.createElement('li');
                listItem.className = `p-4 rounded-lg shadow-lg flex justify-between items-center transition duration-300 ${uni.isUH ? 'bg-primary-red text-white scale-[1.02] border-4 border-yellow-300' : 'bg-gray-100 hover:bg-white'}`;
                
                listItem.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <span class="text-2xl font-black ${uni.isUH ? 'text-white' : medalColors[rank] || 'text-gray-800'}">#${rank}</span>
                        <span class="text-xl font-bold ${uni.isUH ? 'text-white' : 'text-gray-800'}">${uni.name} ${uni.isUH ? '(You)' : ''}</span>
                    </div>
                    <div class="text-right">
                        <span class="text-2xl font-extrabold ${uni.isUH ? 'text-yellow-300' : 'text-primary-red'}">${uni.score.toLocaleString()} pts</span>
                    </div>
                `;
                leaderboardList.appendChild(listItem);
            });

             // Ensure 5 slots are displayed
            while (leaderboardList.children.length < 5) {
                 const listItem = document.createElement('li');
                 listItem.className = 'p-4 bg-gray-50 rounded-lg shadow-md flex justify-between items-center text-gray-400';
                 listItem.textContent = `... University slot waiting for data ...`;
                 leaderboardList.appendChild(listItem);
            }
        }


        // --- 6. INITIALIZATION ON WINDOW LOAD ---
        window.onload = function() {
            // Set up event listeners for navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(e.target.dataset.target);
                });
            });

            // Initialize the default view (Map & Data)
            initMapAndCharts();

            // Set up the Challenge Timer
            challengeEndDate = calculateChallengeEndDate();
            setInterval(updateTimer, 1000);
            updateTimer(); // Initial call to display the timer immediately
            
            // Display User ID 
            if (window.auth && window.auth.currentUser) {
                document.getElementById('user-id').textContent = window.auth.currentUser.uid;
            } else {
                document.getElementById('user-id').textContent = 'ANONYMOUS/DEFAULT';
            }
        };

    </script>
</body>
</html>
